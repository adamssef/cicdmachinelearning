<?php

/**
 * @file
 * Primary module hooks for planet_event_pages module.
 */

/**
 * Implements hook_theme().
 */
function planet_event_pages_theme()
{
  return [
    'node__events' => [
      'template' => 'node--events',
      'base hook' => 'node'
    ],
    'node__main_events_page' => [
      'template' => 'node--main-events-page',
      'base hook' => 'node'
    ]
  ];
}

function planet_event_pages_preprocess_node(&$variables)
{
  $node = $variables['node'];
  
  $planet_core_node_translation_service = \Drupal::service('planet_core.node_translation_service');
  $planet_events = \Drupal::service('planet.event_pages_service');

  $alias = \Drupal::service('path_alias.manager')->getAliasByPath('/node/' . $node->id());

  $events_node = $planet_core_node_translation_service->getNodeByPathAlias("/events");
  $events_aliases = $planet_core_node_translation_service->buildTranslationArrayForNode($events_node);

  if ($node && $node->getType() === 'events') {
    $variables['#attached']['library'][] = 'planet_event_pages/tailwind';
  }

  if (in_array($alias, $events_aliases)) {
    $variables['#attached']['library'][] = 'planet_event_pages/tailwind';
    $variables['featured'] = $planet_events->getFeaturedEvent();
    return;
  }

}

function planet_event_pages_preprocess_node__events(&$variables)
{
  $planet_core_node_translation_service = \Drupal::service('planet_core.node_translation_service');
  $events_landing_page_url = $planet_core_node_translation_service->translateUrlAlias('/events');
  $variables['events_landing_page_url'] = $events_landing_page_url;
}

function planet_event_pages_theme_suggestions_node_alter(array &$suggestions, array $variables)
{
  $node = \Drupal::routeMatch()->getParameter('node');
  if (!$node || !($node instanceof \Drupal\node\NodeInterface)) {
    return;
  }
  $alias = \Drupal::service('path_alias.manager')->getAliasByPath('/node/' . $node->id());

  $planet_core_node_translation_service = \Drupal::service('planet_core.node_translation_service');

  $events_node = $planet_core_node_translation_service->getNodeByPathAlias("/events");
  $events_aliases = $planet_core_node_translation_service->buildTranslationArrayForNode($events_node);

  // Homepage v2 suggestions  
  if (in_array($alias, $events_aliases)) {
    $suggestions[] = 'node__main_events_page';
    return;
  }
}