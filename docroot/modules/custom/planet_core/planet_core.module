<?php

/**
 * @file
 * Custom hooks functions for Planet Core.
 */

use Drupal\webform\WebformSubmissionInterface;
use Drupal\node\NodeInterface;
use Drupal\Core\Session\AccountInterface;
use Drupal\Core\Access\AccessResult;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\TranslatableInterface;

/**
 * Sanitize cookie.
 */
function _planet_core_sanitize_cookie($value) {
  return filter_var($value, FILTER_SANITIZE_STRING);
}

/**
 * Implements hook_preprocess_html().
 *
 * Changes the title of the user page.
 */
function planet_core_preprocess_html(&$variables): void {
  $routeName = \Drupal::routeMatch()->getRouteName();
  if ($routeName === 'entity.user.canonical') {
    $variables['head_title']['title'] = '';
  }
}

/**
 * Implements hook_ENTITY_TYPE_presave().
 */
function planet_core_webform_submission_presave(WebformSubmissionInterface $webform_submission): void {

  $webform = $webform_submission->getWebform();
  $webform_id = $webform->id();

  // Check for the variables to send the UTMs to the form.
  $cookie_utm_source = isset($_COOKIE['Drupal_visitor_utm_source']) ? _planet_core_sanitize_cookie($_COOKIE['Drupal_visitor_utm_source']) : '';
  $cookie_utm_medium = isset($_COOKIE['Drupal_visitor_utm_medium']) ? _planet_core_sanitize_cookie($_COOKIE['Drupal_visitor_utm_medium']) : '';
  $cookie_utm_campaign = isset($_COOKIE['Drupal_visitor_utm_campaign']) ? _planet_core_sanitize_cookie($_COOKIE['Drupal_visitor_utm_campaign']) : '';
  $cookie_utm_term = isset($_COOKIE['Drupal_visitor_utm_term']) ? _planet_core_sanitize_cookie($_COOKIE['Drupal_visitor_utm_term']) : '';
  $cookie_utm_content = isset($_COOKIE['Drupal_visitor_utm_content']) ? _planet_core_sanitize_cookie($_COOKIE['Drupal_visitor_utm_content']) : '';
  $cookie_gclid = isset($_COOKIE['Drupal_visitor_gclid']) ? _planet_core_sanitize_cookie($_COOKIE['Drupal_visitor_gclid']) : '';

  if ($cookie_utm_source) {
    $webform_submission->setElementData('utm_source', $cookie_utm_source);
  }

  if ($cookie_utm_medium) {
    $webform_submission->setElementData('utm_medium', $cookie_utm_medium);
  }

  if ($cookie_utm_campaign) {
    $webform_submission->setElementData('utm_campaign', $cookie_utm_campaign);
  }

  if ($cookie_utm_content) {
    $webform_submission->setElementData('utm_content', $cookie_utm_content);
  }

  if ($cookie_utm_term) {
    $webform_submission->setElementData('utm_term', $cookie_utm_term);
  }

  if ($cookie_gclid) {
    $webform_submission->setElementData('gclid', $cookie_gclid);
  }

  /** SUPPORT FORM - temporary */
  if ($webform_id === 'support') {
    // Populate the value of 'Support_Address__c' with the same value as 'email'.
    // Need it in order to have Salesforce to send an e-mail.
    $email = $webform_submission->getElementData('email');
    $webform_submission->setElementData('support_address__c', $email );
  }
}

/**
 * Implements hook_form_views_exposed_form_alter().
 *
 * Creates region/country dependent filter.
 */
function planet_core_form_views_exposed_form_alter(&$form, &$form_state): void {
  if ($form['#id'] === 'views-exposed-form-companies-registered-companies') {
    unset($form['region']['#options']['All']);

    $regions = \Drupal::entityTypeManager()->getStorage('taxonomy_term')->loadTree('regions');
    if ($region = reset($regions)) {
      $form['region']['#default_value'] = $region->tid;
    }

    $input = $form_state->getUserInput();
    $selectedRegion = $input['region'];
    if ($selectedRegion === 'All') {
      $selectedRegion = array_key_first($form['region']['#options']);
    }

    $countries = _planet_core_get_associative_countries_with_region($selectedRegion);
    $form['country']['#options'] = $countries;

    $form['#attached']['library'][] = 'planet_sitestudio_custom_elements/registeredCompanies';
  }
}

/**
 * Gets countries associated with the region.
 */
function _planet_core_get_associative_countries_with_region(string $regionId): array {
  $countries = [];
  $countries['All'] = 'All';
  $vid = 'countries';

  $terms = \Drupal::entityTypeManager()->getStorage('taxonomy_term')->loadTree($vid, 0, NULL, TRUE);
  if ($regionId != 'All') {
    $terms = \Drupal::entityTypeManager()->getStorage('taxonomy_term')->loadByProperties([
      'vid' => $vid,
      'field_region' => $regionId,
    ]);
  }

  foreach ($terms as $term) {
    $countries[$term->id()] = $term->label();
  }

  return $countries;
}

/**
 * Implements hook_node_access().
 */
function planet_core_node_access(NodeInterface $node, $op, AccountInterface $account) {
  if ($account->isAnonymous() && $node->gettype() == 'webform') {
    return AccessResult::forbidden()->cachePerPermissions();
  }

  return AccessResult::neutral()->cachePerPermissions();
}

/**
 * Implements hook_theme().
 */
function planet_core_theme(): array {
  return [
    'views_view_fields__case_studies__featured_slider' => [
      'template' => 'views-view-fields--case-studies--featured-slider',
      'render element' => 'elements',
      'base hook' => 'views_view',
    ],
    'views_view_fields__case_studies__featured_block' => [
      'template' => 'views-view-fields--case-studies--featured-block',
      'render element' => 'elements',
      'base hook' => 'views_view',
    ],
    'paragraph__right_side_mega_menu' => [
      'template' => 'paragraph--right-side-mega-menu',
      'base hook' => 'paragraph',
    ],
  ];
}

/**
 * Implements hook_entity_insert().
 */
function planet_core_entity_insert(EntityInterface $entity): void {
  _planet_core_update_untranslated_path($entity, 'insert');
}

/**
 * Implements hook_entity_update().
 */
function planet_core_entity_update(EntityInterface $entity): void {
  _planet_core_update_untranslated_path($entity, 'update');
}

/**
 * Trigger pathauto for untranslated content.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   The entity object.
 * @param string $action
 *   The action performed in the entity.
 */
function _planet_core_update_untranslated_path(EntityInterface $entity, string $action): void {
  $pathautoGenerator = \Drupal::service('pathauto.generator');

  // Check if entity has pathauto enabled and is translatable.
  if (!$pathautoGenerator->getPatternByEntity($entity) || !($entity instanceof TranslatableInterface)) {
    return;
  }

  $translatedLanguages = $entity->getTranslationLanguages();
  $allLanguages = \Drupal::languageManager()->getLanguages();
  $untranslatedLanguages = array_diff_key($allLanguages, $translatedLanguages);

  foreach ($untranslatedLanguages as $langcode => $language) {
    $translation = $entity->addTranslation($langcode, $entity->toArray());
    $pathautoGenerator->updateEntityAlias($translation, $action);
  }
}

/**
 * Fix "Non-translatable fields can only be changed when updating the original language." issue.
 */
function planet_core_entity_type_alter(array &$entity_types) {
  foreach ($entity_types as $entity_type) {
    $constraints = $entity_type->getConstraints();
    unset($constraints['EntityUntranslatableFields']);
    $entity_type->setConstraints($constraints);
  }
}
