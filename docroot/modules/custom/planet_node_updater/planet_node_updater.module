<?php

/**
 * @file
 * Primary module hooks for planet_node_updater module.
 */

use Drupal\cohesion_elements\Entity\CohesionLayout;
use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_theme().
 */
function planet_node_updater_theme(): array {
  return [
    'block__system_main_block_contact_sales' => [
      'template' => 'block--system-main-block-contact-sales',
      'base hook' => 'block',
    ],
  ];
}

/**
 * Implements hook_entity_presave().
 */
function planet_node_updater_entity_presave(EntityInterface $entity) {
  if ($entity instanceof CohesionLayout) {
    $default_langcode = $entity->get('default_langcode')->getValue();
    $current_language = \Drupal::languageManager()->getCurrentLanguage()->getId();

    if (empty($default_langcode)) {
      $entity->set('default_langcode', $current_language === 'en');
    }
  }
}

/**
 * Implements hook_theme_suggestions_HOOK_alter().
 */
function planet_node_updater_theme_suggestions_block_alter(array &$suggestions, array &$variables) {
  $node = \Drupal::routeMatch()->getParameter('node');
  $route_object = \Drupal::routeMatch()->getRouteObject();
  $is_admin_page = \Drupal::service('router.admin_context')->isAdminRoute($route_object);

  if (!$node || $is_admin_page) {
    return;
  }

  if (!method_exists($node, 'getType')) {
    return;
  }

  $type = $node->getType();

  if (
    $type === 'page' &&
    isset($variables['elements']['#plugin_id']) &&
    $variables['elements']['#plugin_id'] === 'system_main_block'
  ) {
    if (
      $node->hasField('field_is_product_page') &&
      !$node->get('field_is_product_page')->isEmpty()
    ) {
      $is_product_page_field = $node->get('field_is_product_page')->getValue();
      $is_product_page = !empty($is_product_page_field[0]['value']) ? $is_product_page_field[0]['value'] : NULL;

      if (!$is_admin_page && $node && $node->id() == 376) {
        $suggestions[] = 'block__system_main_block_contact_sales';

        if (
          $node->hasField('field_html_content') &&
          !$node->get('field_html_content')->isEmpty()
        ) {
          $html_content_field = $node->get('field_html_content')->getValue();
          $variables['html_content'] = !empty($html_content_field[0]['value']) ? $html_content_field[0]['value'] : '';
        } else {
          $variables['html_content'] = '';
        }

        $variables['brands'] = \Drupal::service('planet_core.case_studies_helper')->getBrandsWeWorkWith();
        $variables['node'] = $node;

        try {
          $webform_storage = \Drupal::entityTypeManager()->getStorage('webform');
          $webform = $webform_storage->load('get_in_touch_dynamic');
          $variables['form'] = $webform ? $webform->getSubmissionForm() : NULL;
        } catch (\Exception $e) {
          \Drupal::logger('planet_node_updater')->error('Failed to load webform: @message', ['@message' => $e->getMessage()]);
          $variables['form'] = NULL;
        }
      }
    }
  }
}

/**
 * Implements hook_preprocess_block().
 */
function planet_node_updater_preprocess_block(array &$variables) {
  $node = \Drupal::routeMatch()->getParameter('node');
  $route_object = \Drupal::routeMatch()->getRouteObject();
  $is_admin_page = \Drupal::service('router.admin_context')->isAdminRoute($route_object);

  if (!$is_admin_page && $node && $node->id() == 376) {
    $variables['#attached']['library'][] = 'planet_node_updater/planet_node_updater_contact_sales';
    $variables['#attached']['library'][] = 'planet_core/brands-we-work-with';
    $variables['#attached']['library'][] = 'planet_core/swiper-bundle';
  }
}

/**
 * Implements hook_preprocess_node().
 */
function planet_node_updater_preprocess_node(array &$variables) {
  $node = \Drupal::routeMatch()->getParameter('node');
  $route_object = \Drupal::routeMatch()->getRouteObject();
  $is_admin_page = \Drupal::service('router.admin_context')->isAdminRoute($route_object);

  if (!$is_admin_page && $node && $node->id() == 41) {
    $variables['#attached']['library'][] = 'planet_node_updater/planet_node_updater_contact';
  }
}
